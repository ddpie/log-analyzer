name: Kiro Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main, develop]

jobs:
  code-review:
    runs-on: self-hosted
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}
      
      - name: Run Code Review
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # è¿è¡Œå®¡æŸ¥å¹¶ä¿å­˜ç»“æœ
          kiro-cli chat --no-interactive \
            --trust-tools "read,shell" \
            "Review PR #${PR_NUMBER}. 
             Use 'gh pr diff ${PR_NUMBER}' to get changes.
             Post review with 'gh pr review ${PR_NUMBER} --comment --body <review>'.
             Output in Chinese.
             
             IMPORTANT: After posting the review:
             - If you found CRITICAL (ä¸¥é‡) or SECURITY (å®‰å…¨) issues, create a file /tmp/review_failed
             - If no critical issues, do NOT create this file" \
            2>&1 | tee /tmp/review_output.txt
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ä¸¥é‡é—®é¢˜
          if [ -f /tmp/review_failed ]; then
            echo "âŒ Code review found critical issues!"
            rm -f /tmp/review_failed
            exit 1
          fi
          
          # ä¹Ÿæ£€æŸ¥è¾“å‡ºä¸­æ˜¯å¦åŒ…å«ä¸¥é‡é—®é¢˜æ ‡è®°
          if grep -q "ğŸš¨" /tmp/review_output.txt; then
            echo "âŒ Code review found critical issues!"
            exit 1
          fi
          
          echo "âœ… Code review passed"
