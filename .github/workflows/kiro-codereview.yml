name: Kiro Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main, develop]

jobs:
  code-review:
    runs-on: self-hosted
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Get PR diff
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          gh pr diff ${PR_NUMBER} > /tmp/pr_diff.txt
          echo "PR diff saved to /tmp/pr_diff.txt"

      - name: Run Code Review
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # è®© Kiro CLI åªè¾“å‡ºå®¡æŸ¥ç»“æœï¼Œä¸è¦è‡ªå·±å‘å¸ƒè¯„è®º
          kiro-cli chat --no-interactive \
            --trust-tools "read" \
            "è¯·å®¡æŸ¥ä»¥ä¸‹ä»£ç å˜æ›´ï¼Œè¾“å‡ºå®¡æŸ¥ç»“æœï¼ˆä¸­æ–‡ï¼‰ã€‚

             å˜æ›´å†…å®¹åœ¨æ–‡ä»¶: /tmp/pr_diff.txt

             è¾“å‡ºæ ¼å¼è¦æ±‚ï¼š
             1. å…ˆè¾“å‡º '## ä»£ç å®¡æŸ¥ç»“æœ' æ ‡é¢˜
             2. åˆ—å‡ºå‘ç°çš„é—®é¢˜ï¼ˆå¦‚æœ‰ï¼‰ï¼Œä½¿ç”¨ ğŸš¨ æ ‡è®°ä¸¥é‡é—®é¢˜
             3. æœ€åç»™å‡ºç»“è®ºï¼šæ˜¯å¦å»ºè®®åˆå¹¶

             æ³¨æ„ï¼šåªè¾“å‡ºå®¡æŸ¥ç»“æœæ–‡æœ¬ï¼Œä¸è¦æ‰§è¡Œä»»ä½• gh å‘½ä»¤ï¼Œä¸è¦å‘å¸ƒè¯„è®ºã€‚" \
            > /tmp/review_result.txt 2>&1

          cat /tmp/review_result.txt

      - name: Post review comment
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # ç»Ÿä¸€å‘å¸ƒä¸€æ¬¡è¯„è®º
          if [ -s /tmp/review_result.txt ]; then
            gh pr review ${PR_NUMBER} --comment --body "$(cat /tmp/review_result.txt)"
            echo "âœ… Review posted"
          else
            echo "âš ï¸ No review content generated"
          fi

      - name: Check for critical issues
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰ä¸¥é‡é—®é¢˜
          if grep -q "ğŸš¨" /tmp/review_result.txt; then
            echo "âŒ Code review found critical issues!"
            exit 1
          fi

          echo "âœ… Code review passed"
