name: Kiro Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main, develop]

jobs:
  code-review:
    runs-on: self-hosted
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Get PR diff
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          gh pr diff ${PR_NUMBER} > /tmp/pr_diff.txt
          echo "PR diff saved to /tmp/pr_diff.txt"

      - name: Run Code Review
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          NO_COLOR: "1"
          TERM: "dumb"
        run: |
          # è®© Kiro CLI å°†å®¡æŸ¥ç»“æœå†™å…¥æ–‡ä»¶
          kiro-cli chat --no-interactive \
            --trust-tools "read,write" \
            "è¯·å®¡æŸ¥ /tmp/pr_diff.txt ä¸­çš„ä»£ç å˜æ›´ï¼Œå°†ç»“æœå†™å…¥ /tmp/review_result.txtã€‚

             ## å®¡æŸ¥è§„åˆ™

             ### ğŸš¨ ä¸¥é‡é—®é¢˜ (å¿…é¡»ä¿®å¤)
             - å®‰å…¨æ¼æ´ï¼šSQLæ³¨å…¥ã€XSSã€ç¡¬ç¼–ç å¯†é’¥/å¯†ç ã€è·¯å¾„éå†
             - ç©ºæŒ‡é’ˆ/æœªå®šä¹‰å¼•ç”¨ï¼šæœªæ£€æŸ¥ null/undefined/None
             - èµ„æºæ³„æ¼ï¼šæœªå…³é—­æ–‡ä»¶ã€æ•°æ®åº“è¿æ¥ã€ç½‘ç»œè¿æ¥
             - è¯­æ³•é”™è¯¯ï¼šå¯¼è‡´ä»£ç æ— æ³•è¿è¡Œçš„é”™è¯¯

             ### âš ï¸ é«˜ä¼˜å…ˆçº§é—®é¢˜
             - é”™è¯¯å¤„ç†ç¼ºå¤±ï¼šç©º catchã€å¿½ç•¥é”™è¯¯è¿”å›å€¼
             - å¹¶å‘é—®é¢˜ï¼šç«æ€æ¡ä»¶ã€æ­»é”é£é™©
             - å†…å­˜é—®é¢˜ï¼šå†…å­˜æ³„æ¼ã€ç¼“å†²åŒºæº¢å‡º
             - ç±»å‹é”™è¯¯ï¼šç±»å‹ä¸åŒ¹é…ã€any æ»¥ç”¨

             ### ğŸ“ å»ºè®®æ”¹è¿›
             - ä»£ç é£æ ¼ï¼šå‘½åä¸è§„èŒƒã€è¿‡é•¿å‡½æ•°
             - æ€§èƒ½é—®é¢˜ï¼šN+1æŸ¥è¯¢ã€å¾ªç¯ä¸­çš„é‡å¤è®¡ç®—
             - å¯ç»´æŠ¤æ€§ï¼šç¼ºå°‘æ³¨é‡Šã€é‡å¤ä»£ç 

             ### è¯­è¨€ç‰¹å®šæ£€æŸ¥
             **Python**: è£¸ exceptã€å¯å˜é»˜è®¤å‚æ•°ã€æœªä½¿ç”¨ with è¯­å¥
             **Java**: æœªä½¿ç”¨ try-with-resourcesã€å­—ç¬¦ä¸²æ‹¼æ¥ã€æ³›å‹ Exception
             **JavaScript/TypeScript**: ç¼ºå°‘ awaitã€== ä»£æ›¿ ===ã€æœªå¤„ç† Promise reject
             **Go**: å¿½ç•¥ errorã€nil æŒ‡é’ˆã€goroutine æ³„æ¼
             **SQL**: å­—ç¬¦ä¸²æ‹¼æ¥æŸ¥è¯¢ã€ç¼ºå°‘å‚æ•°åŒ–

             ## è¾“å‡ºæ ¼å¼

             ## ä»£ç å®¡æŸ¥ç»“æœ

             ### å‘ç°çš„é—®é¢˜
             ğŸš¨ **ä¸¥é‡**: [æ–‡ä»¶:è¡Œå·] é—®é¢˜æè¿°
             âš ï¸ **è­¦å‘Š**: [æ–‡ä»¶:è¡Œå·] é—®é¢˜æè¿°
             ğŸ“ **å»ºè®®**: [æ–‡ä»¶:è¡Œå·] é—®é¢˜æè¿°

             ### ç»“è®º
             âœ… å»ºè®®åˆå¹¶ / âŒ ä¸å»ºè®®åˆå¹¶ - åŸå› 

             ---
             *ç”± Kiro CLI è‡ªåŠ¨å®¡æŸ¥*

             é‡è¦ï¼šåªå†™å…¥æ–‡ä»¶ï¼Œä¸è¦è¾“å‡ºåˆ°ç»ˆç«¯ï¼Œä¸è¦æ‰§è¡Œ gh å‘½ä»¤ã€‚"

          # æ£€æŸ¥ç»“æœæ–‡ä»¶
          if [ -f /tmp/review_result.txt ]; then
            cat /tmp/review_result.txt
          else
            echo "âš ï¸ å®¡æŸ¥ç»“æœæ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          fi

      - name: Post review comment
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # ç»Ÿä¸€å‘å¸ƒä¸€æ¬¡è¯„è®º
          if [ -s /tmp/review_result.txt ]; then
            gh pr review ${PR_NUMBER} --comment --body "$(cat /tmp/review_result.txt)"
            echo "âœ… Review posted"
          else
            echo "âš ï¸ No review content generated"
          fi

      - name: Check for critical issues
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰ä¸¥é‡é—®é¢˜
          if grep -q "ğŸš¨" /tmp/review_result.txt; then
            echo "âŒ Code review found critical issues!"
            exit 1
          fi

          echo "âœ… Code review passed"
